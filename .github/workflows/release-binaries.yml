name: Release Binaries

on:
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            targets: "--target x86_64-unknown-linux-gnu --target x86_64-unknown-linux-musl --target aarch64-unknown-linux-gnu --target aarch64-unknown-linux-musl"
          - os: macos-latest
            targets: "--target x86_64-apple-darwin --target aarch64-apple-darwin"
          - os: windows-latest
            targets: "--target x86_64-pc-windows-msvc --target aarch64-pc-windows-msvc"
    env:
      CI: true
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Install Linux cross toolchains
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y musl-tools gcc-aarch64-linux-gnu

      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Add Rust targets (Linux)
        if: runner.os == 'Linux'
        run: rustup target add x86_64-unknown-linux-musl aarch64-unknown-linux-gnu aarch64-unknown-linux-musl

      - name: Add Rust targets (macOS)
        if: runner.os == 'macOS'
        run: rustup target add x86_64-apple-darwin aarch64-apple-darwin

      - name: Add Rust targets (Windows)
        if: runner.os == 'Windows'
        run: rustup target add aarch64-pc-windows-msvc

      - name: Install cargo-dist (v0.30.2) on Linux/macOS
        if: runner.os != 'Windows'
        run: curl -LsSf https://github.com/axodotdev/cargo-dist/releases/download/v0.30.2/cargo-dist-installer.sh | sh

      - name: Install cargo-dist (v0.30.2) on Windows
        if: runner.os == 'Windows'
        run: powershell -ExecutionPolicy Bypass -Command "Invoke-RestMethod 'https://github.com/axodotdev/cargo-dist/releases/download/v0.30.2/cargo-dist-installer.ps1' | Invoke-Expression"

      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        with:
          cosign-release: "v3.0.2"

      - name: Build artifacts
        run: cargo dist build ${{ matrix.targets }}

      - name: Sign artifacts
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cargo dist sign ${{ matrix.targets }}

      - name: Upload artifacts
        run: cargo dist upload ${{ matrix.targets }}
