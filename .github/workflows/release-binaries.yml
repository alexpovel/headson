name: Release Binaries

on:
  release:
    types: [published]
  push:
    tags: ["headson-v*"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    permissions:
      contents: write
      id-token: write
    env:
      CI: true
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Linux cross toolchains
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y musl-tools gcc-aarch64-linux-gnu

      - name: Set up Rust (stable)
        uses: actions/setup-rust@v1
        with:
          rust-version: stable

      - name: Add Rust targets (Linux)
        if: runner.os == 'Linux'
        run: rustup target add x86_64-unknown-linux-musl aarch64-unknown-linux-gnu aarch64-unknown-linux-musl

      - name: Add Rust targets (macOS)
        if: runner.os == 'macOS'
        run: rustup target add x86_64-apple-darwin aarch64-apple-darwin

      - name: Add Rust targets (Windows)
        if: runner.os == 'Windows'
        run: rustup target add aarch64-pc-windows-msvc

      - name: Install cargo-dist (v0.30.2) on Linux/macOS
        if: runner.os != 'Windows'
        run: curl -LsSf https://github.com/axodotdev/cargo-dist/releases/download/v0.30.2/cargo-dist-installer.sh | sh

      - name: Install cargo-dist (v0.30.2) on Windows
        if: runner.os == 'Windows'
        run: powershell -ExecutionPolicy Bypass -Command "Invoke-RestMethod 'https://github.com/axodotdev/cargo-dist/releases/download/v0.30.2/cargo-dist-installer.ps1' | Invoke-Expression"

      - name: Add cargo bin to PATH
        run: echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Install cosign
        uses: sigstore/cosign-installer@v4.0.0
        with:
          cosign-release: "v3.0.2"

      - name: Build artifacts
        run: cargo dist build

      - name: Sign artifacts
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: cargo dist sign

      - name: Upload artifacts
        run: cargo dist upload
